#ns rmlbcir.tcl -traf traffile -mov movfilesetdest -optpampa policy-delpwr -optargs "3e6 2"
#ns rmlbcir.tcl -traf traffile -mov movfilesetdest -optdelay 0 -optargs "3e6 2"
if [ $# -ne 4 ]
then
	echo -e "Usage:  simbcir.sh  <nodes> <runs> <delay> <jitter>\n **** This is just a simple test ****"
	exit 1
else

NAM=0
LOG=1

START=`date +%s`
FAIL=0
DROPFLOOD=0
FLOOD=0

INITIATOR=0
STARTTIME=1
SIZE=1000 #Packet - Message size in Bytes
DELAY=$3
JITTER=$4

TOTALFAILFLOOD=0
TOTALFAIL_ACK_FLOOD=0
TOTALFAILBERS=0
TOTALFAIL_ACK_BERS=0
TOTALFAILBCIR=0
TOTALFAIL_ACK_BCIR=0

RESULTPATH="/dev/shm/ramfs"
LOGPATH="../backup/LOG"

if [ $LOG -ne 0 ]; then
	if [ ! -d $LOGPATH ]; then mkdir $LOGPATH; else
		if [ ! "$(ls -A $LOGPATH)" ] ; then rm -rf $LOGPATH/* ; fi
	fi
fi

sed -i 's/set val(usenam).*/set val(usenam) \t\t '$NAM'/g' rmlsearch.tcl



if [ ! -d $RESULTPATH ]; then
    mkdir $RESULTPATH
else
	rm -rf $RESULTPATH/*
fi


#DENS=25 #Nodes/KM
#SIDE=$(echo "scale=2; 1000*sqrt($1/$DENS)" | bc | sed 's/..[0-9]$//') # Calc inside genRandomGeo.py



cp rmlsearch.tcl rmlsearch.tcl.bak
sed -i 's/set val(nn).*/set val(nn) \t\t '$1'/g' rmlsearch.tcl

sed -i 's/set val(out).*/set val(out) \t\t "\/dev\/shm\/ramfs\/rmlsearch"/g' rmlsearch.tcl

if [ -f ./scenarios/cenario1 ]
then
	rm ./scenarios/*
fi




cd simul
if [ -f trans.dat ]
then
	mv trans.dat trans.bak
fi

if [ -f lat.dat ]
then
	mv lat.dat lat.bak
fi
cd ..


for i in traffileflood traffilebcir traffilebers ; do cp traffile $i ; done
sed -i 's/ns_ at.*/ns_ at '$STARTTIME' "$bcir_('$INITIATOR') flood '$SIZE' '$DELAY' '$JITTER'"/g' traffileflood
sed -i 's/ns_ at.*/ns_ at '$STARTTIME' "$bcir_('$INITIATOR') bers '$SIZE' '$DELAY' '$JITTER'"/g' traffilebers
sed -i 's/ns_ at.*/ns_ at '$STARTTIME' "$bcir_('$INITIATOR') bcir '$SIZE' '$DELAY' '$JITTER'"/g' traffilebcir

for (( c=1; c<=$2; c++ ))
do

	FAILFLOOD=0
	FAIL_ACK_FLOOD=0
	FAILBERS=0
	FAIL_ACK_BERS=0
	FAILBCIR=0
	FAIL_ACK_BCIR=0

	SIDE=$(python genRandomGeo.py $1)
	echo $SIDE

	sed -i 's/set val(x).*/set val(x) \t\t '$SIDE'/g' rmlsearch.tcl
	sed -i 's/set val(y).*/set val(y) \t\t '$SIDE'/g' rmlsearch.tcl


	cp cenario ./scenarios/cenario$c
	cp network.png ./scenarios/network$c.png


#	for ((resource=$(( $1-1 )); resource<$1; resource++)) > /dev/null 2>&1
	for ((resource=1; resource<$1; resource++))
	do
		echo -e "################# ITR = $c \t NODE = $resource ##################"
		ns rmlsearch.tcl -traf traffileflood -mov cenario -proto flood -resource $resource  > /dev/null 2>&1
		ns rmlsearch.tcl -traf traffilebers -mov cenario -proto bers -resource $resource  > /dev/null 2>&1
		ns rmlsearch.tcl -traf traffilebcir -mov cenario -proto bcir -resource $resource  > /dev/null 2>&1

		#sync
		#sleep 1 #Wait to finish writing







		LATFLOOD=`./lat.awk $RESULTPATH/rmlsearchflood.tr`
		LATBERS=`./lat.awk $RESULTPATH/rmlsearchbers.tr`
		LATBCIR=`./lat.awk $RESULTPATH/rmlsearchbcir.tr`
#		LATBCIR2=`./lat.awk $RESULTPATH/rmlsearchbcir2.tr`


		if [ ! "$LATBERS" = -1 ]; then
			HOPS=`./hop.awk $RESULTPATH/rmlsearchbers.tr`
                elif [ ! "$LATBCIR" = -1 ]; then
			HOPS=`./hop.awk $RESULTPATH/rmlsearchbcir.tr`
#               elif [ ! "$LATBCIR2" = -1 ]; then
#			HOPS=`./hop.awk $RESULTPATH/rmlsearchbcir2.tr`
		elif [ ! "$LATFLOOD" = -1 ]; then
                        HOPS=`./hop.awk $RESULTPATH/rmlsearchflood.tr`
		else
			HOPS=-1
                fi



		if [ "$LATFLOOD"  = -1 ]
		then
			TRFLOOD=-1
			FAILFLOOD=$(($FAILFLOOD + 1))
			if grep --quiet Found $RESULTPATH/rmlsearchflood.tr; then FAIL_ACK_FLOOD=$(($FAIL_ACK_FLOOD + 1)); fi
		else
			TRFLOOD=`./trans.awk $RESULTPATH/rmlsearchflood.tr`
		fi

		if [ "$LATBERS" = -1 ]
		then
                        TRBERS=-1
			FAILBERS=$(($FAILBERS + 1))
			if grep --quiet Found $RESULTPATH/rmlsearchbers.tr; then FAIL_ACK_BERS=$(($FAIL_ACK_BERS + 1)); fi
                else
			TRBERS=`./trans.awk $RESULTPATH/rmlsearchbers.tr`
		fi

		if [ "$LATBCIR" = -1 ]
		then
                        TRBCIR=-1
			FAILBCIR=$(($FAILBCIR + 1))
			if grep --quiet Found $RESULTPATH/rmlsearchbcir.tr; then FAIL_ACK_BCIR=$(($FAIL_ACK_BCIR + 1)); fi
                else
			TRBCIR=`./trans.awk $RESULTPATH/rmlsearchbcir.tr`
		fi

#		if [ "$LATBCIR2" = -1 ]
#		then
#                        TRBCIR2=-1
#			FAILBCIR2=$(($FAILBCIR2 + 1))
#                else
#			TRBCIR2=`./trans.awk $RESULTPATH/rmlsearchbcir.tr`
#			if [ $LOG -ne 0 ]
#			then
#				cp $RESULTPATH/rmlsearchbcir2.tr "$LOGPATH"/rmlsearchbcir2_"$c"_"$resource".tr
#			fi
#		fi



		if [ ! "$HOPS" = -1 ] ; then
		echo -e $resource "\t" $HOPS "\t" $LATFLOOD "\t" $LATBERS "\t" $LATBCIR  >> ./simul/lat.dat
		echo -e $resource "\t" $HOPS "\t" $TRFLOOD "\t" $TRBERS "\t" $TRBCIR  >> ./simul/trans.dat
		fi
#		if grep -q "Resource at Initiator" ./simul/rmlsearchbers.tr \
#			&& grep -q "Resource at Initiator" ./simul/rmlsearchbcir.tr ; then
#    			echo yes
#			./simul/geradat.sh $resource
#			echo -e $resource "\t" `./hop.awk ./simul/rmlsearchflood.tr` "\t" `./trans.awk ./simul/rmlsearchflood.tr` "\t" `./trans.awk ./simul/rmlsearchbers.tr` "\t" `./trans.awk ./simul/rmlsearchbcir.tr` >> ./simul/trans.dat
#			echo -e $resource "\t" `./hop.awk ./simul/rmlsearchflood.tr` "\t" `./lat.awk ./simul/rmlsearchflood.tr` "\t" `./lat.awk ./simul/rmlsearchbers.tr` "\t" `./lat.awk ./simul/rmlsearchbcir.tr` >> ./simul/lat.dat
#		else
#    			echo ALERT: No Resource Found
#			TEMP_FAIL=`expr $TEMP_FAIL + 1`
#		fi
		if [ $LOG -ne 0 ]
			then
				cp $RESULTPATH/rmlsearchflood.tr "$LOGPATH"/rmlsearchflood_"$c"_"$resource".tr
				cp $RESULTPATH/rmlsearchbers.tr "$LOGPATH"/rmlsearchbers_"$c"_"$resource".tr
				cp $RESULTPATH/rmlsearchbcir.tr "$LOGPATH"/rmlsearchbcir_"$c"_"$resource".tr
			fi

	done
	TOTALFAILFLOOD=$(( $TOTALFAILFLOOD + $FAILFLOOD ))
	TOTALFAILBERS=$(( $TOTALFAILBERS + $FAILBERS ))
	TOTALFAILBCIR=$(( $TOTALFAILBCIR + $FAILBCIR ))
	TOTALFAIL_ACK_FLOOD=$(( $TOTALFAIL_ACK_FLOOD + $FAIL_ACK_FLOOD ))
	TOTALFAIL_ACK_BERS=$(( $TOTALFAIL_ACK_BERS + $FAIL_ACK_BERS ))
	TOTALFAIL_ACK_BCIR=$(( $TOTALFAIL_ACK_BCIR + $FAIL_ACK_BCIR ))


done
DROPFLOOD=($(./drop.awk $RESULTPATH/rmlsearchflood.tr))
DROPBERS=($(./drop.awk $RESULTPATH/rmlsearchbers.tr))
DROPBCIR=($(./drop.awk $RESULTPATH/rmlsearchbcir.tr))

EVDROPFLOOD=($(./dropevent.awk $RESULTPATH/rmlsearchflood.tr))
EVDROPBERS=($(./dropevent.awk $RESULTPATH/rmlsearchbers.tr))
EVDROPBCIR=($(./dropevent.awk $RESULTPATH/rmlsearchbcir.tr))



cd simul
if [ -f lat.dat ]
then
 #	./clearnegative.sh
	./mediaslat.awk lat.dat
	cat temp1 | sort -gk 1 > latflood.dat
	cat temp2 | sort -gk 1 > latbers.dat
	cat temp3 | sort -gk 1 > latbcir.dat
	rm temp*

	./mediastrans.awk trans.dat
        cat temp1 | sort -gk 1 > transflood.dat
        cat temp2 | sort -gk 1 > transbers.dat
        cat temp3 | sort -gk 1 > transbcir.dat
	rm temp*

	./freq.awk ./lat.dat > freq.dat
	cat freq.dat | sort -gk 1 | sed '/^-1/d' > freq2.dat
	#./geradat2.sh
	./graphops.sh
fi

cd ..

#### Last Simulation Time ####
FLOODTIME=($(./time.awk $RESULTPATH/rmlsearchflood.tr))
BERSTIME=($(./time.awk $RESULTPATH/rmlsearchbers.tr))
BCIRTIME=($(./time.awk $RESULTPATH/rmlsearchbcir.tr))



END=`date +%s`
DIFF=$(( $END - $START ))
{
echo "######################## Log Simulation ##########################"
echo "Date:`date`"
echo "Nodes: $1"
echo "Area: "$SIDE"x"$SIDE"m² = $(( $SIDE*$SIDE/1000000 )) Km²"
echo "Density: $((($1 * 1000000) / ($SIDE * $SIDE))) Nodes/Km²"
echo "Iterations: $2"
echo "TOTAL Search: $(( $1*$2 ))"
echo "DelayFlood: rng.uniform($DELAY,$JITTER)"
echo "AddedDelay: $DELAY*2*H+DelayFlood"
if [ $LOG -ne 0 ]; then SPACE=`du -s $LOGPATH| awk '{print $1}'`;echo "Total LOG size: $SPACE";fi
echo "############################ TIME ################################"
echo "Execution time was $(($DIFF / 60)) minutes and $(($DIFF % 60)) seconds =  $(($DIFF / 3600)) Hours" 
echo "################### GLOBAL CONNECTIVITY  #########################"
echo -e "FLOOD FAILS : $TOTALFAILFLOOD / $TOTALFAIL_ACK_FLOOD \t $(($TOTALFAILFLOOD * 100 / ($1*$2) ))%"
echo -e "BERS  FAILS : $TOTALFAILBERS / $TOTALFAIL_ACK_BERS \t $(($TOTALFAILBERS * 100 / ($1*$2) ))%"
echo -e "BCIR  FAILS : $TOTALFAILBCIR / $TOTALFAIL_ACK_BCIR \t $(($TOTALFAILBCIR * 100 / ($1*$2) ))%"
echo "##################################################################"
echo "################# LAST NETWORK - LAST SEARCH #####################"
echo "##################################################################"
echo "####### Simulation TIME  - Last Network - Last Search ############"
echo -e "Simulation Time FLOOD: $FLOODTIME"
echo -e "Simulation Time BERS:  $BERSTIME"
echo -e "Simulation Time BCIR:  $BCIRTIME"
echo "##################################################################"
echo "########## CONNECTIVITY - Last Network - Last Search  ############"
echo -e "FLOOD FAILS : $FAILFLOOD / $FAIL_ACK_FLOOD \t $(($FAILFLOOD * 100 / $1 ))%"
echo -e "BERS  FAILS : $FAILBERS / $FAIL_ACK_BERS \t $(($FAILBERS * 100 / $1 ))%"
echo -e "BCIR  FAILS : $FAILBCIR / $FAIL_ACK_BCIR \t $(($FAILBCIR * 100 / $1 ))%"
echo "##################################################################"
echo "########## COLLISIONS - Last Network - Last Search ###############"
echo -e "Drops at FLOOD - Last: $DROPFLOOD \t $(($DROPFLOOD * 100 / $1))%"
echo -e "Drops at BERS  - Last: $DROPBERS \t $(($DROPBERS * 100 / $1))%"
echo -e "Drops at BCIR  - Last: $DROPBCIR \t $(($DROPBCIR * 100 / $1))%"
echo "##### EVENT COLLISIONS - Last Network - Last Search ##############"
echo -e "Drops at FLOOD - Last: $EVDROPFLOOD \t $(($EVDROPFLOOD * 100 / $1))%"
echo -e "Drops at BERS  - Last: $EVDROPBERS \t $(($EVDROPBERS * 100 / $1))%"
echo -e "Drops at BCIR  - Last: $EVDROPBCIR \t $(($EVDROPBCIR * 100 / $1))%"
echo "##################################################################"
echo "######################### FLOOD ##################################"
./rate.awk $RESULTPATH/rmlsearchflood.tr
echo "########################## BERS ##################################"
./rate.awk $RESULTPATH/rmlsearchbers.tr
echo "########################## BCIR ##################################"
./rate.awk $RESULTPATH/rmlsearchbcir.tr
} | tee log.txt

fi

exit 0

#	ns rmlsearch.tcl -traf traffileflood -mov movfilesetdest -proto flood -resource $resource
